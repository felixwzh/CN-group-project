# 复习 

## 第 3 章 数据链路层 

数据链路层的主要作用是如何**可靠**的把数据传输到相邻节点

###3.1 使用点对点信道的数据链路层

#### 3.1.1 数据链路 

- 把实现用来控制数据在link上传输的**通讯协议**的软件和硬件加在链路上，就构成了**数据链路**。

#### 3.1.2 三个基本问题

1.  封装成帧（framing）
   - 给IP数据报添加帧首部（e.g. **SOH**）和帧尾部（e.g. **EOT**），并且数据部分（即IP数据报）有最长限制MTU（Maximum Transfer Unit）
   - 首/尾部 的作用是**帧界定**，并且在数据传输出现差错的时候用处更加明显。可以直接丢弃这个帧，直到下一个有完整首部和尾部的帧。
2.  透明传输
   - 使用**字节填充**的方法
   - 如果IP数据报中刚好有EOT，则在EOT前面加一个转义字符ESC，在读取数据是删除这个ESC再给网络层即可。
   - 如果IP数据报中刚好有ESC，则在前面再加一个转义字符ESC，在读取时遇到连续的两个ESC就删除前一个即可。
3.  差错检测
   - 我们这里讨论的是**比特差错**，衡量标准是误码率BER（Bit Error Rate）
   - 使用CRC（Cyclic Redundant Check）循环冗余检验
   - 对于一个K位的组，选取一个R位的除数，在K位数据后加R-1个0，然后用K0000模2除以除数，得到R-1位的余数。这个余数就是FCS（Frame Check Sequence）。在发送这个组的数据时，把K位的数据后面拼接上这R-1位的余数，即使真正发送出去的数据
   - 在检验的时候，使用这个接受到的数据（K+R-1）位模2除以之前用的除数，如果结果为0，则接受，如果 结果非0，则认为出现了比特差错，丢弃这个组。
   - 使用CRC得到的仅仅是**无差错接受**，不是**可靠传输**。无法解决 帧丢失、重复、失序问题。

###3.2 点对点协议 PPP 

用户连接到ISP的链路使用PPP

#### 3.2.1 PPP 协议的特点

1. 简单
2. 封装成帧
3. 透明
4. 差错检验
5. 适应多种网络协议
6. 适应多种链路
7. 最大传输长度MTU
8. 检测链路连接状态
9. 网络层地址协商
10. 数据压缩协商

#### 3.2.2 PPP 协议的帧格式

- 字段的意义：
  - 首部：0x7E, 0xFF, 0x03 +2字节的协议+
  - 数据部分：(<1500字节的数据)
  - 尾部：2字节的FCS+0x7E
  - 两个帧之间只有一个0x7E
- 字节填充
  - 用于异步的字节传输
  - 使用0x7D作为转义字符
  - 0x7E->0x7D,0x5E
  - 0x7D->0x7D,0x5D
  - 小于0x20的ASCII控制字符，0x03->0x7D,0x23
- 零比特填充
  - 用于同步的比特连续传输
  - 在连续的5个1后面填充一个0

###3.3 使用广播信道的数据链路层

#### 3.3.1 局域网的数据链路层

- 局域网最主演的特点：
  1. 网络为一个单位所有
  2. 网络范围和站点数目均有限
- 局域网的拓扑有：
  - 星型网
  - 环状网
  - 总线网
  - 树状网

#### 3.3.2 CSMA/CD 协议

Carrie Sense Multiple Access with Collision Detection 载波监听多点接入/碰撞检测

**争用期**：512比特时间

**截短二进制指数避退算法** 

**强化碰撞**：32/48 比特时间

**帧间最小间隔**：96比特时间

1. 如果要发送数据，则一直监听直到有了96比特时间的空闲
2. 开始发送并且持续监听信道：
   1. 如果在512比特的争用期还没有发现碰撞，则这个帧可以顺利发送
   2. 若果有碰撞，则立即停止发送，并且发送一个人为干扰信号，执行指数退避 算法，等待r 倍的512比特时间。再开始1。如果16次还不成功则停止发送并且上报错。

#### 3.3.3 使用集线器的星形拓扑

- 双绞线以太网总是和集线器配合使用的。
- 使用集线器的以太网在逻辑上还是一个总线网，各站共享逻辑上的总线，使用的还是CSMA/CD协议
- 集线器就像一个多接口的转发器，他使用电子器件来模拟实际电缆线的工作。整个系统依然像一个传统的以太网那样运行。

#### 3.3.4 以太网的信道利用率

- $\tau$ 是以太网单程端到端**传播时延**，$2\tau$是争用期。
- $T_0$是发送帧用的时间
- $\alpha=\tau/T_0$ 参数来描述以太网的信道利用率，尽可能小比较好
  - 当数据率一定时，以太网的连线不能太长，否则$\tau$会太大
  - 以太网的帧不能太短，否则$T_0$太小导致$\alpha$太大

#### 3.3.5 以太网的 MAC 层

- MAC层的硬件地址，MAC地址，是局域网通信设备或端口的唯一标识符

  - 共48位
  - 前24位是组织唯一标识符
  - 后24位是扩展唯一标识符
  - I/G位：第一个字节的最低位，0->Individual 单个站地址，1-> Group 组地址（用来进行**多播**）
  - 当48位全为1时，是**广播**地址
  - 适配器检查MAC地址

- MAC帧的格式-共5个字段，最短64字节长

  1. 目的地址字段-6字节
  2. 源地址字段-6字节
  3. 类型字段-2字节，说明上层网络层的协议类型
  4. 数据字段-46~1500字节
  5. FCS字段-4字节
  6. 实际发送的还要多8个字节：，这部分字节不进行CRC校验
     - 7个字节的前同步码
     - 1个字节的帧开始界定符

  - 对收到 的MAC帧
    - 如果长度不是整数字节，丢弃
    - 如果FCS校验失败，丢弃
    - 如果数据字段的长度不在46~1500字节之间

### 3.4 扩展的以太网

#### 3.4.1 在物理层扩展以太网

- 使用集线器把多个星型以太网的集线器组成更大的以太网。把多个小碰撞域组成一个大的碰撞域
- 优点：
  - 原来不能通信的可以了，可以跨碰撞域
  - 扩大的以太网的物理范围
- 缺点：
  - 总的吞吐量没有提升
  - 如果不同碰撞域的数据率不一样，则不能连在一起

#### 3.4.2 在数据链路层扩展以太网

- 早期使用网桥，现在使用以太网交换机
- 网桥：根据MAC帧的目的地址对收到的帧进行转发和过滤
- 交换机：以太网交换机 / 第二层交换机，工作在数据链路层
- 有自学习算法，交换表一开始是空的
  - 先进行**自学习**，在交换表中查找源地址

    - **自学习只对源地址和接口进行学习**！！！

    1. 如果没有，则将源地址、接口、有效时间添加到交换表中
    2. 如果有，则更新接口和有效时间

  - 再进行转发，在交换表中查找目的地址
    1. 如果没有，则向除了源接口的所有接口转发
    2. 如果有，则只向对应的接口转发
    3. 如果就是源接口，则丢弃这一帧
- 转发器、集线器、网桥、交换机的不同点
  - 工作的层不一样
  - 前两个简单的进行比特转发，后两个需要读帧的含义
  - 网桥一般2~4个接口，而交换机有十几或几十个接口
  - 网桥的接入一般是网段，而交换机还可以是单独的主机

#### 3.4.3 虚拟局域网 VLAN （Virtual Local Area Network）

- 在以太网帧中原本的6+6+2+（46~1500）+4字节中添加4个字节的**VLAN标记字段**在源地址字段之后。变成了**802.1Q帧**
- 前两个字节为**IEEE 802.1Q标记类型**
- 后两个字节前3位为用户优先级，第4位为规范格式指示符，后12位为**VID**，VLAN-ID
- 以太网的最长帧长度从1518->1522字节




## 第4章 网络层

### 4.1 网络层提供的两种服务 

#### 数据报服务 

- 无连接、简单灵活、尽最大能力交付。

#### 虚电路服务

- 面向连接

### 4.2 网际协议 IP 

有3个子协议

1. **ARP**：address resolution protocol
2. **ICMP**：Internet control message protocol
3. **IGMP**：Internet group management protocol

#### 4.2.1 IP互连网络

使用相同IP的计算机互联构成的网络，各个物理网络可以是异构的

#### 4.2.2 分类的 IP 地址

1. 一共分为哪几类？
2. 每一类的net-id起始规定是什么？
3. 每一类可用的net-id和host-id数目是多少？
4. 每一类的起始net-id和终止net-id是多少？
5. net-id全零、host-id全1、net-id=127+host-id非全0非全1、分别可用于源、目的地址吗？用途是什么？
6. IP地址有哪些特性？
   1. net、host-id分离：管理？路由转发？
   2. 一个IP地址就 代表了一个接口，一个主机有多个接口就有多个IP地址，路由器至少有两个IP地址
   3. 用网桥连接的还是同一个局域网
   4. 在IP地址中，所有分配到网络号的网络都是平等的
   5. 两个路由器直连，之间的接口可/也可不分配IP地址

#### 4.2.3 IP 地址与硬件地址

IP地址对数据链路层时完全不可见的，路由器的数据链路层只是负责转发帧，在剥离得到IP数据报后的网络层才知道IP地址。然后再封装成帧给下一个路由、

#### 4.2.4 地址解析协议 ARP

每台主机有一个ARP Cache，里面存放若干\<ip-add，mac-add，TTL>

每当一个主机需要发送ip数据报时，先看cache中有没有对应的条目

- 如果有，就 把对应的mac-add写入到mac帧，通过数据链路层发送给对应的地址
- 如果没有，就在局域网发送一个**请求分组** ，说出自己IP地址，MAC地址。请求目的IP地址的MAC地址，得到后写入cache发送。并且目的的IP地址的MAC地址的主机也存下发送请求的IP-MAC-TTL对

#### 4.2.5 IP 数据报的格式

- 由首部和数据部分组成
- 首部有20字节的**固定字段**部分和1~40字节的可变**选项字段**
- 固定字段有：
  - 版本 4位：如IPV4
  - TTL 8位：最大转发次数
  - 协议 8位：上层协议

#### 4.2.6 IP 层转发分组的流程

见P128

1. 提取net-id $N$  和 目的主机IP地址 $D$
2. 直接交付？
3. 特定主机路由？
4. 到达$N$的路由？ 
5. 默认路由？
6. 报告转发分组错误

### 4.3 划分子网 

#### 4.3.1 划分子网

net-id,subnet-id,host-id

优点：

- 减少IP地址的浪费
- 便于管理维护
- 网络组织更灵活



#### 4.3.2 使用子网时分组的转发

和不使用子网时的

- 相同点是什么？ 都只知道目的地址
- 不同点？
  - 路由表{目的网络net-id，子网掩码，下一跳地址}
  - 使用我要去的地址逐行与路由表的子网掩码相与，比较是不是这个目的网络

### 4.4 网际控制报文协议 ICMP 

#### PING （Packet InterNet Groper）

- 检测两个站点的连通性
- 是应用层直接使用网络层的例子
- 使用了ICMP的回送**请求报文**和回送**回答报文**

#### Traceroute

- 向主机发送一连串的数据报，封装的是无法交付的UDP用户数据报
- 使用了ICMP的**时间超过差错报告报文**和**终点不可达差错报告报文**

### 4.5 互联网的路由选择协议 

#### 4.5.1 有关路由选择协议的几个基本概念

**IGP**：interior gateway protocol 内部网关协议

**EGP**：external gateway protocol 外部网关协议

#### 4.5.2 内部网关协议 RIP

- 路由信息协议 route information protocol
- 距离的定义？
- 3个问题
  - 和谁交换？
  - 交换什么信息？\<网络，距离，下一跳地址>的路由表
  - 什么时候交换？
- 距离向量算法
  - 改下一跳地址
  - 增加距离
  - 看这个网络是否在自己的表里
    - 不在，直接加
    - 在，且下一跳一样，直接更新，不论变大变小
    - 在，且下一跳不一样，则只有距离小时才更新

#### 4.5.3 内部网关协议 OSPF

开方最短路径优先（open shortest path first）

在一个自治系统内

三个要点/问题：

1. 向谁发送信息？ :向本自治系统中的所有路由器发送，使用**洪泛法**
2. 发送什么信息？与本路由器相邻的所有路由器的**链路状态**
   - 什么是链路状态？
3. 什么时候发送信息？当链路状态**发生变化时**

其他重点：

- 对于不同的业务类型可以计算出不同的路由
- 如果有多条相同代价的路径，那么可以将通信量分配，多路径间的**负载平衡**
- 支持可变长度的子网划分
- 每个链路状态都有一个32位的序号，越大越新
- 定时刷新数据库中的链路状态

> - 由于一个路由器的链路状态只涉及到与相邻路 由器的连通状态，因而与整个互联网的规模并 无直接关系。因此当互联网规模很大时，OSPF协议要比距离向量协议 RIP **好得多。**
>
>
> - OSPF 没有“坏消息传播得慢”的问题，据统 计，其响应网络变化的时间小于 100 ms。

#### 4.5.4 外部网关协议 BGP

边界网关协议 Border Gateway Protocol, 不同AS之间的路由器交换路由信息的协议

- 采用路径**向量路由选择协议**
- 每个AS至少有一个路由器作为**BGP发言人**
- BGP发言人之间交换路由信息先建立TCP连接
- 在BGP 刚刚运行时，BGP 的邻站是交换整个的 BGP 路由表。但以后只需要在发生变化时更新有变化的部分

### 4.6 IPv6 

#### 与IPv4的不同

- 地址长度，128位，4倍于
- 更丰富的层次
- 灵活的首部格式
- 协议允许继续扩充
- 支持即插即用
- 支持资源预分配
- 首部8字节对齐

IPv6数据部分的两大部分：

- 基本首部
- 有效载荷，可以有0~多个扩展首部

####  4.6.1 IPv6的基本首部

####  4.6.2 IPv6的地址

- 128位
- 16进制冒号表示法
- 00AB可以写为AB，注意是省去前面的0
- 连续的一长串0可以压缩为：：
- 只能压缩一次

####  4.6.3 从IPv4向IPv6过渡

- 使用双协议栈
  - 某些主机/路由器有两个协议v4v6，可以进行两种IP数据报的转换。
  - 但是不可避免会出现v6数据报的一部分信息丢失
- 使用隧道技术
  - 把v6数据报作为v4数据报的数据部分包装起来。
  - 注意v4隧道中的目的地址源地址和v6的不一样。

####  4.6.4 ICMPv6

- ARP和ICGP**合并**到了ICMPv6中

### 4.7 IP 多播

#### 4.7.1 IP 多播的基本概念 

#### 4.7.2 在局域网上进行硬件多播 

#### 4.7.3 网际组管理协议 IGMP 和多播路由选择协议

- IGMP是让本局域网上的多播路由器知道本局域网有哪些主机加入或退出了哪个多播组

- IGMP的两个阶段：

  - **加入多播组**

    主机向谁发送报文？

    谁又来转发这个组成员关系？


  - **探询组成员的变化情况**

- 多播路由选择实际上就是要找出以源主机为根节点的多播转发树

  - 洪泛与剪枝

    适用于较小的多播组，并且组成员接入的局域网邻接

  - 隧道技术

    适用于多播组的位置在地理上很分散的情况

  - **基于核心的发现技术** \<$没懂$>

    对多播组的大小在较大范围内变化时都适合

### 4.8 虚拟专用网 VPN 和网络地址转换 NAT

#### 4.8.1 虚拟专用网 VPN 

- 采用专用IP地址的互联网络又称为**专用网**
- 利用公用的互联网作为本机构各专用网之间的通信载体，这样的专用网称为虚拟专用网VPN(virtual private network)

#### 4.8.2 网络地址转换 NAT

- network address translation
- 一个NAT有n个全球IP地址，就能给专用网内的n个主机接入到互联网
- 专用网内部的主机不能当服务器用



# 第 5 章 运输层 

### 5.1 运输层协议概述 

#### 5.1.1 进程之间的通信 

- 位于什么地方的主机的协议栈才有运输层？网络核心部分中的路由器在转发分组 时都只用到下三层的功能
- 运输层/IP层有**复用**和**分用**的功能

#### 5.1.2 运输层的两个主要协议

- TCP： Transmission control protocol
  - 全双工可靠信道
  - 数据单位是TCP报文段，segment
  - 面向连接的服务
  - 不提供广播或多播服务
  - 有许多额外的开销
- UDP：user datagram protocol
  - 不可靠信道
  - 数据单位是UDP报文
  - 无连接服务
  - 传输前不需要建立连接
  - 收到后不需要确认

#### 5.1.3 运输层的端口

- 16位-65535个不同的端口号
- 服务器端使用的端口号
  - 熟知端口号 0~1023
  - 登记端口号 1024~49151
- 客户端使用的端口号 49152~65535

### 5.2 用户数据报协议 UDP

#### 5.2.1 UDP 概述 

相比于IP层只增加了

1. 分用和复用的功能
2. 差错检验的功能

特点（6点）

1. 无连接
2. 尽最大可能交付
3. 面向报文，不做切分，直接作为数据段
4. 没有拥塞控制，不会使源主机发送速率降低
5. 可面向一/多对一/多
6. 首部小，8字节

#### 5.2.2 UDP 的首部格式

2字节源端口+2字节目的端口+2字节长度（最小为8）+2字节检验和

伪首部12字节，仅用于检验和的计算。

### 5.3 传输控制协议 TCP 概述 

#### 5.3.1 TCP 最主要的特点 

1. 面向连接
2. 点对点
3. 可靠交付
4. 全双工
5. 面向字节流

TCP把收到的字节流分段，形成报文段，再发送

- 分段依据：对方给出的**窗口值**以及**网络拥塞程度**

#### 5.3.2 TCP 的连接

连接的端点是套接字-socket

socket={IP:port}

### 5.4 可靠传输的工作原理 

#### 5.4.1 停止等待协议 

理想的传输条件有 两个特点：

1. 传输信道无差错
2. 无论发送方发送的速度如何，接收方总是来得及处理

停止等待：

- 无差错情况


- 丢失重传
- 确认丢失
- 确认迟到
- 信道利用率
  - $$ U=\frac{T_D}{T_D+RTT+T_A}$$

#### 5.4.2 连续 ARQ 协议

发送方

- 发送方维持一个发送窗口，窗口内的分组都可以发送而不需要等待ACK
- 每收到一个ACK就把窗口向前移动一位

接收方

- 不用每个分组都ACK，可以等待连续的几个分组 后只ACK最后一个，叫做**累积确认**

### 5.5 TCP 报文段的首部格式

20字节的固定内容+4n字节的选项

- 源端口，2字节

- 目的端口，2字节

- 序号，4字节，本报文段传输的第一个字节的序号，数据流的每个字节都有序号

- 确认号，4字节，接收方希望收到的下一个报文号是什么。如201+500=701. 表明701字节前（到700为止）的字节数据均已收到。

  窗口，2字节，指出接收方允许发送方发送的量，动态变化中。

### 5.6 TCP 可靠传输的实现 

### 5.7 TCP 的流量控制 

### 5.8 TCP 的拥塞控制

### 5.9 TCP 的运输连接管理


# 复习 

## 第 1 章 计算机网络概述

### 1.1 性能指标

#### 1.1.1 速率

* “数据率” = “比特率”，bit/s, kbit/s, Mbit/s, Gbit/s, 4* **10^10^** = 40 Gbit/s
* 一般不是指实际运行速率而是**额定**速率

#### 1.1.2 带宽 (bandwidth)

* 无线网络中指频带宽度（单位：赫）
* 有线网络中指传送数据的能力，某信道单位时间内的“最高数据率”（单位：比特每秒）
* 时间轴上**信号的宽度**随带宽的增大而变窄

#### 1.1.3 吞吐量 (throughput)

* 单位时间内通过某个网络/信道/接口的数据量
* 表征实际上到底有多少数据量能够通过网络
* 受带宽或速率的限制

#### 1.1.4 时延 (delay/latency)

* 数据（一个报文/分组/比特）从网络/链路的一端传送到另一端所需的时间
* 延迟/迟延
* 总时延 = 发送时延+传播时延+处理时延 + 排队时延
  * 发送时延 = 帧长度(bit) / 发送速率(bit/s)
  * 传播时延 = 信道长度(**m**) / 信号在信道上的传播速率(**m/s**)
  * 处理时延 = 分析首部 / 提取数据 / 差错检验 / 查找路由
  * 排队时延 = 分组在**路由器**输入输出队列中的时延。取决于网络中当时的通信量
  * 几种时延产生的地方不一样
* 高速网络提高的仅仅是数据的**发送速率**而不是**传播速率**

### 1.2 网络体系结构

#### 1.2.1 协议与划分层次

* 网络协议（简称为协议）是为进行网络中的数据交换而建立的规则，标准或约定

* 两种国际标准

  * OSI 官方，无市场认可
  * TCP/IP 非标准，应用广泛。事实上的国际标准

* 具有5层协议的体系结构

  * OSI：     应用，  表示，   会话，        运输，                  网络，      数据链路，物理
  * TCP/IP：应用[DNS/HTTP/SMTP]，   运输[TCP/UDP]，网络[IP]，网络接口层
  * **本课**：应用，运输，网络，数据链路，物理

* 发送过程

  * 加上应用层首部->**应用层PDU**(Protocol Data Unit, 对等层次之间传送的数据单位)
  * 加上运输层首部成为**运输层报文**
  * 加上网络层首部，成为**IP数据报**（或分组）
  * 加上链路层首部和尾部，成为**数据链路层帧**
  * 物理层把比特流传送到物理媒体
  * 电信号/光信号从发送端物理层到接收端物理层
  * 逐一去掉首部/尾部，层层上交

  ![数据发送](.\数据发送.png)

## 第 2 章 物理层

### 2.1 基本概念

#### 通过实例理解

* ZigBee （O-QPSK）

  * Spread （**这个有点不清楚**， 好像是将1个bit扩展成4bits一个的chips）

    * Modulation调制 （将chips调制为复数信号，实部和虚部刚好正交，一共2^4^ = 16个数）
    * Pulse Shaping脉冲整形 （将突变的脉冲信号整形为正弦波）
    * DAC 数模转换
    * 加载波
    * 逆向过程略

* WiFi （OFDM）

  * Serial to Parallel
  * 信号到复坐标的映射
  * 逆FFT
  * 正交合成实部和虚部
  * 载波
  * Data' = Preamble + Data
  * **根据调制方式、码率计算传输速率**

### 2.2 数据通信的基础知识

#### 2.2.1 数据通信系统的模型

三大部分：源系统、传输系统和目的系统

数据、信号、模拟信号、数字信号

#### 2.2.2 信道的基本概念

* 信道
* 单向通信（单工通信）
* 双向交替通信（半双工通信）
* 双向同时通信（全双工通信）
* 基带信号（基本频带信号），很多信号并不能传输基带信号中的低频/直流分量，需要**调制**
* 编码方式：不归零制、归零制、曼彻斯特编码（中部向上跳变0向下跳变1）、差分曼彻斯特编码（开始时有跳变为0没跳变为1）
* 基本带通调制方法：调幅、调频、调相
* 正交振幅调制（QAM），4 bit用一个点传输，传输率提高4倍。码元越多，解调时出错率越高

#### 2.2.3 信道的极限容量

* 信噪比(dB) = $10\log_{10}(S/N)$, S=信号的平均功率，N=噪声的平均功率
* 香农[带宽受限且有高斯白噪声干扰的极限的无差错的]信息传输速率极限 $C = W\log_{2}(1+S/N)$, C(bits/s), W(Hz), S信号平均功率，N高斯噪声功率

### 2.3 物理层下面的传输媒体

即传输介质/媒介：导引型/非导引型

#### 2.3.1 导引型传输媒体

* 双绞线：屏蔽STP，无屏蔽UTP
* 同轴电缆：抗干扰，LAN/数字传输，有线电视/模拟传输
* 光纤：频率非常高，带宽很大。全反射。折射率外低内高
  * 容量大，损耗小，抗雷电/电磁干扰，无串音（保密性好），体积小重量轻

#### 2.3.2 非导引型传输媒体

* 即自由空间
* 频段很广
* **微波**主要是直线传播：地面微波接力通信；卫星通信
* ISM, 可自由使用的频段：$[902, 928]MHz，[2.4, 2.4835]GHz, [5.725, 5.850]GHz$

### 2.4 信道复用技术

#### 频分复用 (FDM = F D(ivision) M(ultiplexing))

* 所有用户在同样的时间占用不同的**带宽**[频率带宽]资源

#### 时分复用 (TDM)

* TDM信号也称等时信号
* 将时间划分为时分复用帧，每个用户占用**固定序号**的时隙，每个用户的时隙周期为TDM帧长度
* 在不同的时间占用同样的频带宽度
* 可能造成线路资源浪费（某无数据发送的用户的时隙空闲）

#### 码分复用 (CDM)

* 码分多址（CDMA）
* 各用户码型特殊挑选不会干扰
* 码片(chip)序列：发1bit $\rightarrow$ 发m bit；发送1 = 发送码片序列，发送0 = 发送反码
* 扩频：直接序列扩频（如上例），跳频扩频
* CDMA特点：码片序列**必须** 不同、互相正交
  * 解码（规格化内积）时出现乱码说明解码时用的码片错了，出现持续m bit的0-1信号说明正确

### 2.5 宽带接入技术

* 接入网络需要先连接到ISP
* \> 200kbit/s

####2.5.1 ADSL 技术

* 是对现有的模拟电话线进行改造使之能承载宽带

* 0~4kHz留给传统电话；用户线本身其实能超过1MHz，高端频谱用于上网

* 传输距离取决于数据率和用户线的线径（速率越快距离越短，线越细衰减越大）

* 特点：

  * 上[User$\rightarrow$ISP]下[ISP$\rightarrow$User]行带宽不对称
  * 用户线两端各安装一个ADSL调制解调器
  * 离散多音调[多载波/多子信道]DMT调制技术

* DMT：40kHz ~ 1.1MHz分为25上行子信道+249个下行子信道

  每个子信道4kHz带宽，并使用不同的载波调制

  **相当于在一对用户线上使用许多小的调制解调器并行地传送数据**

* ADSL数据率：自适应调制技术，通过测试可用频率、干扰情况、传输质量提供尽可能高的数据率

#### 2.5.2 光纤同轴混合网 （HFC）

* CATV网采用模拟技术的频分复用对电视节目进行单向传输
* HFC将原CATV的主干部分改为**光纤**，使用**模拟光纤技术**，采用光的**振幅**调制
* 电缆调制解调器（Cable Modem，为HFC使用），传输速率高，**不成对使用**，只安装在用户端

#### 2.5.3  FTTx技术

* FTTH（光纤到户），FTTB（光纤到楼），FTTC（到路边），FTTP（到用户所在地）
* 剩余的入户媒介是电缆/双绞线
* 通常使用**无源**光纤网络（纯介质网络，成本低）



## 第 3 章 数据链路层 

数据链路层的主要作用是如何**可靠**的把数据传输到相邻节点

###3.1 使用点对点信道的数据链路层

#### 3.1.1 数据链路 

- 把实现用来控制数据在link上传输的**通讯协议**的软件和硬件加在链路上，就构成了**数据链路**。

#### 3.1.2 三个基本问题

1.  封装成帧（framing）
   - 给IP数据报添加帧首部（e.g. **SOH**）和帧尾部（e.g. **EOT**），并且数据部分（即IP数据报）有最长限制MTU（Maximum Transfer Unit）
   - 首/尾部 的作用是**帧界定**，并且在数据传输出现差错的时候用处更加明显。可以直接丢弃这个帧，直到下一个有完整首部和尾部的帧。
2.  透明传输
   - 使用**字节填充**的方法
   - 如果IP数据报中刚好有EOT，则在EOT前面加一个转义字符ESC，在读取数据是删除这个ESC再给网络层即可。
   - 如果IP数据报中刚好有ESC，则在前面再加一个转义字符ESC，在读取时遇到连续的两个ESC就删除前一个即可。
3.  差错检测
   - 我们这里讨论的是**比特差错**，衡量标准是误码率BER（Bit Error Rate）
   - 使用CRC（Cyclic Redundant Check）循环冗余检验
   - 对于一个K位的组，选取一个R位的除数，在K位数据后加R-1个0，然后用K0000模2除以除数，得到R-1位的余数。这个余数就是FCS（Frame Check Sequence）。在发送这个组的数据时，把K位的数据后面拼接上这R-1位的余数，即使真正发送出去的数据
   - 在检验的时候，使用这个接受到的数据（K+R-1）位模2除以之前用的除数，如果结果为0，则接受，如果 结果非0，则认为出现了比特差错，丢弃这个组。
   - 使用CRC得到的仅仅是**无差错接受**，不是**可靠传输**。无法解决 帧丢失、重复、失序问题。

###3.2 点对点协议 PPP 

用户连接到ISP的链路使用PPP

#### 3.2.1 PPP 协议的特点

1. 简单
2. 封装成帧
3. 透明
4. 差错检验
5. 适应多种网络协议
6. 适应多种链路
7. 最大传输长度MTU
8. 检测链路连接状态
9. 网络层地址协商
10. 数据压缩协商

#### 3.2.2 PPP 协议的帧格式

- 字段的意义：
  - 首部：0x7E, 0xFF, 0x03 +2字节的协议+
  - 数据部分：(<1500字节的数据)
  - 尾部：2字节的FCS+0x7E
  - 两个帧之间只有一个0x7E
- 字节填充
  - 用于异步的字节传输
  - 使用0x7D作为转义字符
  - 0x7E->0x7D,0x5E
  - 0x7D->0x7D,0x5D
  - 小于0x20的ASCII控制字符，0x03->0x7D,0x23
- 零比特填充
  - 用于同步的比特连续传输
  - 在连续的5个1后面填充一个0

###3.3 使用广播信道的数据链路层

#### 3.3.1 局域网的数据链路层

- 局域网最主演的特点：
  1. 网络为一个单位所有
  2. 网络范围和站点数目均有限
- 局域网的拓扑有：
  - 星型网
  - 环状网
  - 总线网
  - 树状网

#### 3.3.2 CSMA/CD 协议

##### 以太网为了通讯方便的措施

1. **无连接**的工作方式，以太网是尽最大努力交付。
2. 以太网发送的数据都是用**曼切斯特**编码的信号

Carrie Sense Multiple Access with Collision Detection 载波监听多点接入/碰撞检测

**争用期**：512比特时间

**截短二进制指数避退算法** 

**强化碰撞**：32/48 比特时间

**帧间最小间隔**：96比特时间

1. 如果要发送数据，则一直监听直到有了96比特时间的空闲
2. 开始发送并且持续监听信道：
   1. 如果在512比特的争用期还没有发现碰撞，则这个帧可以顺利发送
   2. 若果有碰撞，则立即停止发送，并且发送一个人为干扰信号，执行指数退避 算法，等待r 倍的512比特时间。再开始1。如果16次还不成功则停止发送并且上报错。

#### 3.3.3 使用集线器的星形拓扑

##### 星形以太网10BASE-T 标准

- 10：10Mb/s
- BASE: 连接线上是基带信号
- T: 使用双绞线



- 双绞线以太网总是和集线器配合使用的。
- 使用集线器的以太网在逻辑上还是一个总线网，各站共享逻辑上的总线，使用的还是CSMA/CD协议
- 集线器就像一个多接口的转发器，他使用电子器件来模拟实际电缆线的工作。整个系统依然像一个传统的以太网那样运行。

#### 3.3.4 以太网的信道利用率

- $\tau$ 是以太网单程端到端**传播时延**，$2\tau$是争用期。
- $T_0$是发送帧用的时间
- $\alpha=\tau/T_0$ 参数来描述以太网的信道利用率，尽可能小比较好
  - 当数据率一定时，以太网的连线不能太长，否则$\tau$会太大
  - 以太网的帧不能太短，否则$T_0$太小导致$\alpha$太大

#### 3.3.5 以太网的 MAC 层

- MAC层的硬件地址，MAC地址，是局域网通信设备或端口的唯一标识符

  - 共48位
  - 前24位是组织唯一标识符
  - 后24位是扩展唯一标识符
  - I/G位：第一个字节的最低位，0->Individual 单个站地址，1-> Group 组地址（用来进行**多播**）
  - 当48位全为1时，是**广播**地址
  - 适配器检查MAC地址

- MAC帧的种类

  - 单播帧，一对一
  - 广播帧，一对全体
  - 多播帧，一对多

- MAC帧的格式-共5个字段，最短64字节长

  1. 目的地址字段-6字节
  2. 源地址字段-6字节
  3. 类型字段-2字节，说明上层网络层的协议类型
  4. 数据字段-46~1500字节
  5. FCS字段-4字节
  6. 实际发送的还要多8个字节：，这部分字节不进行CRC校验
     - 7个字节的前同步码
     - 1个字节的帧开始界定符

  - 对收到 的MAC帧
    - 如果长度不是整数字节，丢弃
    - 如果FCS校验失败，丢弃
    - 如果数据字段的长度不在46~1500字节之间，丢弃

### 3.4 扩展的以太网

#### 3.4.1 在物理层扩展以太网

- 使用集线器把多个星型以太网的集线器组成更大的以太网。把多个小碰撞域组成一个大的碰撞域
- 优点：
  - 原来不能通信的可以了，可以跨碰撞域
  - 扩大的以太网的物理范围
- 缺点：
  - 总的吞吐量没有提升
  - 如果不同碰撞域的数据率不一样，则不能连在一起

#### 3.4.2 在数据链路层扩展以太网

- 使用网桥的优点：
  1. 过滤通信量，增大吞吐量
  2. 扩大了物理范围
  3. 容错性
  4. 可互联不同物理层、MAC子层、不同速率的以太网
- 使用网桥的缺点：
  1. 时延增加
  2. 在MAC层无流量控制，容易失帧
  3. 只适合小型以太网


- 早期使用网桥，现在使用以太网交换机
- 网桥：根据MAC帧的目的地址对收到的帧进行转发和过滤
- 交换机：以太网交换机 / 第二层交换机，工作在数据链路层
- 有自学习算法，交换表一开始是空的
  - 先进行**自学习**，在交换表中查找源地址

    - **自学习只对源地址和接口进行学习**！！！

    1. 如果没有，则将源地址、接口、有效时间添加到交换表中
    2. 如果有，则更新接口和有效时间

  - 再进行转发，在交换表中查找目的地址
    1. 如果没有，则向除了源接口的所有接口转发
    2. 如果有，则只向对应的接口转发
    3. 如果就是源接口，则丢弃这一帧
- 转发器、集线器、网桥、交换机的不同点
  - 工作的层不一样
  - 前两个简单的进行比特转发，后两个需要读帧的含义
  - 网桥一般2~4个接口，而交换机有十几或几十个接口
  - 网桥的接入一般是网段，而交换机还可以是单独的主机

#### 3.4.3 虚拟局域网 VLAN （Virtual Local Area Network）

- 在以太网帧中原本的6+6+2+（46~1500）+4字节中添加4个字节的**VLAN标记字段**在源地址字段之后。变成了**802.1Q帧**
- 前两个字节为**IEEE 802.1Q标记类型**
- 后两个字节前3位为用户优先级，第4位为规范格式指示符，后12位为**VID**，VLAN-ID
- 以太网的最长帧长度从1518->1522字节




## 第4章 网络层

路由器：具有多个输入输出端口的专用计算机，用途是转发分组

### 4.1 网络层提供的两种服务 

#### 数据报服务 

- 无连接、简单灵活、尽最大能力交付。

#### 虚电路服务

- 面向连接

### 4.2 网际协议 IP 

有3个子协议

1. **ARP**：address resolution protocol
2. **ICMP**：Internet control message protocol
3. **IGMP**：Internet group management protocol

#### 4.2.1 IP互连网络

使用相同IP的计算机互联构成的网络，各个物理网络可以是异构的

#### 4.2.2 分类的 IP 地址

1. 一共分为哪几类？
2. 每一类的net-id起始规定是什么？
3. 每一类可用的net-id和host-id数目是多少？
4. 每一类的起始net-id和终止net-id是多少？
5. net-id全零、host-id全1、net-id=127+host-id非全0非全1、分别可用于源、目的地址吗？用途是什么？
6. IP地址有哪些特性？
   1. net、host-id分离：管理？路由转发？
   2. 一个IP地址就 代表了一个接口，一个主机有多个接口就有多个IP地址，路由器至少有两个IP地址
   3. 用网桥连接的还是同一个局域网
   4. 在IP地址中，所有分配到网络号的网络都是平等的
   5. 两个路由器直连，之间的接口可/也可不分配IP地址

#### 4.2.3 IP 地址与硬件地址

IP地址对数据链路层时完全不可见的，路由器的数据链路层只是负责转发帧，在剥离得到IP数据报后的网络层才知道IP地址。然后再封装成帧给下一个路由、

#### 4.2.4 地址解析协议 ARP

每台主机有一个ARP Cache，里面存放若干\<ip-add，mac-add，TTL>

每当一个主机需要发送ip数据报时，先看cache中有没有对应的条目

- 如果有，就 把对应的mac-add写入到mac帧，通过数据链路层发送给对应的地址
- 如果没有，就在局域网发送一个**请求分组** ，说出自己IP地址，MAC地址。请求目的IP地址的MAC地址，得到后写入cache发送。并且目的的IP地址的MAC地址的主机也存下发送请求的IP-MAC-TTL对
- 请求分组是广播
- 响应分组是单播​

#### 4.2.5 IP 数据报的格式

- 由首部和数据部分组成
- 首部有20字节的**固定字段**部分和1~40字节的可变**选项字段**
- 固定字段有：
  - 版本 4位：如IPV4
  - TTL 8位：最大转发次数
  - 协议 8位：上层协议

#### 4.2.6 IP 层转发分组的流程

路由表中最重要的两个信息是：（目的网络地址，下一跳地址）

见P128

1. 提取net-id $N$  和 目的主机IP地址 $D$
2. 直接交付？
3. 目的地址为$D$ 的特定主机路由？
4. 到达$N$的路由？ 
5. 如果路由表中有默认路由？
6. 报告转发分组错误

### 4.3 划分子网 

#### 4.3.1 划分子网

net-id,subnet-id,host-id

优点：

- 减少IP地址的浪费
- 便于管理维护
- 网络组织更灵活



#### 4.3.2 使用子网时分组的转发

和不使用子网时的

- 相同点是什么？ 都只知道目的地址
- 不同点？
  - 路由表{目的网络net-id，子网掩码，下一跳地址}
  - 使用我要去的地址$D$逐行与路由表的子网掩码相与，比较是不是这个目的网络

### 4.4 网际控制报文协议 ICMP 

- ICMP差错报告报文
- ICMP询问报文

#### PING （Packet InterNet Groper）

- 检测两个站点的连通性
- 是应用层直接使用网络层的例子
- 使用了ICMP的回送**请求报文**和回送**回答报文**

#### Traceroute

- 向主机发送一连串的数据报，封装的是无法交付的UDP用户数据报
- 使用了ICMP的**时间超过差错报告报文**和**终点不可达差错报告报文**

### 4.5 互联网的路由选择协议 

![路由选择协议](.\路由选择协议.png)

#### 4.5.1 有关路由选择协议的几个基本概念

**IGP**：interior gateway protocol 内部网关协议

**EGP**：external gateway protocol 外部网关协议

#### 4.5.2 内部网关协议 RIP

- 路由信息协议 route information protocol
- 距离的定义？
- 3个问题
  - 和谁交换？
  - 交换什么信息？**\<网络，距离，下一跳地址>**的路由表
  - 什么时候交换？
- 一条路径最多15步长，16为不可达
- 若一个路由器3分钟没有收到相邻路由的信息，则把距离设置为16-不可达
- 距离向量算法
  - 改下一跳地址
  - 增加距离
  - 看这个网络是否在自己的表里
    - 不在，直接加
    - 在，且下一跳一样，直接更新，不论变大变小
    - 在，且下一跳不一样，则只有距离小时才更新
- 好消息传播的快，坏消息传播的慢

#### 4.5.3 内部网关协议 OSPF

开方最短路径优先（open shortest path first）

在一个自治系统内

三个要点/问题：

1. 向谁发送信息？ :向本自治系统中的所有路由器发送，使用**洪泛法**
2. 发送什么信息？与本路由器相邻的所有路由器的**链路状态**：
   - 什么是链路状态？：说明此路由器与哪些路由器相邻，以及该链路的**度量**
3. 什么时候发送信息？当链路状态**发生变化时**

其他重点：

- **更新过程收敛的快**


- 对于不同的业务类型可以计算出不同的路由
- 如果有多条相同代价的路径，那么可以将通信量分配，多路径间的**负载平衡**
- 支持可变长度的子网划分
- 每个链路状态都有一个32位的序号，越大越新
- 定时刷新数据库中的链路状态

> - 由于一个路由器的链路状态只涉及到与相邻路 由器的连通状态，因而与整个互联网的规模并 无直接关系。因此当互联网规模很大时，OSPF协议要比距离向量协议 RIP **好得多。**
>
>
> - OSPF 没有“坏消息传播得慢”的问题，据统 计，其响应网络变化的时间小于 100 ms。

#### 4.5.4 外部网关协议 BGP

边界网关协议 Border Gateway Protocol, 不同AS之间的路由器交换路由信息的协议

- 采用**路径向量路由选择协议**
- 每个AS至少有一个路由器作为**BGP发言人**
- BGP发言人之间交换路由信息先建立TCP连接
- 在BGP 刚刚运行时，BGP 的邻站是交换整个的 BGP 路由表。但以后只需要在发生变化时更新有变化的部分
- 重点是传达可达性信息

### 4.6 IPv6 

#### 与IPv4的不同

- 地址长度，128位，4倍于
- 更丰富的层次
- 灵活的首部格式
- 协议允许继续扩充
- 支持即插即用
- 支持资源预分配
- 首部8字节对齐
- 多了一个**任播**， 给一组，但只交付一个

IPv6数据部分的两大部分：

- 基本首部
- 有效载荷，可以有0~多个扩展首部

####  4.6.1 IPv6的基本首部

####  4.6.2 IPv6的地址

- **128位**
- 16进制冒号表示法
- 00AB可以写为AB，注意是省去前面的0
- 连续的一长串0可以压缩为：：
- 只能压缩一次

####  4.6.3 从IPv4向IPv6过渡

- 使用双协议栈
  - 某些主机/路由器有两个协议v4v6，可以进行两种IP数据报的转换。
  - 但是不可避免会出现v6数据报的一部分信息丢失，比如**流标号**没有了
- 使用隧道技术
  - 把v6数据报作为v4数据报的数据部分包装起来。
  - 注意v4隧道中的目的地址源地址和v6的不一样。

####  4.6.4 ICMPv6

- ARP和ICGP**合并**到了ICMPv6中

### 4.7 IP 多播

#### 4.7.1 IP 多播的基本概念 

#### 4.7.2 在局域网上进行硬件多播 

#### 4.7.3 网际组管理协议 IGMP 和多播路由选择协议

- IGMP是让本局域网上的多播路由器知道本局域网有哪些主机加入或退出了哪个多播组

- IGMP的两个阶段：

  - **加入多播组**

    主机向谁发送报文？

    谁又来转发这个组成员关系？

    - **探询组成员的变化情况**

- 多播路由选择实际上就是要找出**以源主机为根节点的多播转发树**

  - 洪泛与剪枝

    适用于较小的多播组，并且组成员接入的局域网邻接

  - 隧道技术

    适用于多播组的位置在地理上很分散的情况

  - **基于核心的发现技术** <$没懂$>

    对多播组的大小在较大范围内变化时都适合

### 4.8 虚拟专用网 VPN 和网络地址转换 NAT

#### 4.8.1 虚拟专用网 VPN 

- 采用专用IP地址的互联网络又称为**专用网**
- 利用公用的互联网作为本机构各专用网之间的通信载体，这样的专用网称为虚拟专用网VPN(virtual private network)

#### 4.8.2 网络地址转换 NAT

- network address translation
- 一个NAT有n个全球IP地址，就能给专用网内的n个主机接入到互联网
- 专用网内部的主机不能当服务器用



# 第 5 章 运输层 

### 5.1 运输层协议概述 

#### 5.1.1 进程之间的通信 

- 位于什么地方的主机的协议栈才有运输层？网络核心部分中的路由器在转发分组 时都只用到下三层的功能
- 运输层/IP层有**复用**和**分用**的功能

#### 5.1.2 运输层的两个主要协议

- TCP： Transmission control protocol
  - 全双工可靠信道
  - 数据单位是TCP报文段，segment
  - 面向连接的服务
  - 不提供广播或多播服务
  - 有许多额外的开销
- UDP：user datagram protocol
  - 不可靠信道
  - 数据单位是UDP报文
  - 无连接服务
  - 传输前不需要建立连接
  - 收到后不需要确认

#### 5.1.3 运输层的端口

- 16位-65535个不同的端口号
- 服务器端使用的端口号
  - 熟知端口号 0~1023
  - 登记端口号 1024~49151
- 客户端使用的端口号 49152~65535

### 5.2 用户数据报协议 UDP

#### 5.2.1 UDP 概述 

相比于IP层只增加了

1. 分用和复用的功能
2. 差错检验的功能

特点（6点）

1. 无连接
2. 尽最大努力交付
3. 面向报文，不做切分，直接作为数据段
4. 没有拥塞控制，不会使源主机发送速率降低
5. 可面向一/多对一/多
6. 首部小，8字节

#### 5.2.2 UDP 的首部格式

2字节源端口+2字节目的端口+2字节长度（最小为8）+2字节检验和

伪首部12字节，仅用于检验和的计算。

### 5.3 传输控制协议 TCP 概述 

#### 5.3.1 TCP 最主要的特点 

1. 面向连接
2. 点对点
3. 可靠交付
4. 全双工
5. 面向字节流

TCP把收到的字节流分段，形成报文段，再发送

- 分段依据：对方给出的**窗口值**以及**网络拥塞程度**

#### 5.3.2 TCP 的连接

连接的端点是套接字-socket

socket={IP:port}

### 5.4 可靠传输的工作原理 

#### 5.4.1 停止等待协议 

理想的传输条件有 两个特点：

1. 传输信道无差错
2. 无论发送方发送的速度如何，接收方总是来得及处理

停止等待：

- 无差错情况


- 丢失重传
- 确认丢失
- 确认迟到
- 信道利用率
  - $$ U=\frac{T_D}{T_D+RTT+T_A}$$

#### 5.4.2 连续 ARQ 协议

ARQ：Automatic Repeat reQuest

发送方

- 发送方维持一个发送窗口，窗口内的分组都可以发送而不需要等待ACK
- 每收到一个ACK就把窗口向前移动一位

接收方

- 不用每个分组都ACK，可以等待连续的几个分组 后只ACK最后一个，叫做**累积确认**

### 5.5 TCP 报文段的首部格式

20字节的固定内容+4n字节的选项

- 源端口，2字节

- 目的端口，2字节

- 序号，4字节，本报文段传输的第一个字节的序号，数据流的每个字节都有序号

- 确认号，4字节，接收方希望收到的下一个报文号是什么。如201+500=701. 表明701字节前（到700为止）的字节数据均已收到。

  窗口，2字节，指出接收方允许发送方发送的量，动态变化中。

### 5.6 TCP 可靠传输的实现 

- 什么是发送窗口
- 什么是可用窗口
- 发送缓存？
- 接收缓存？
- 接收窗口？

####  5.6.1 超时重传时间的选择 

- 加权平均往返时间RRTs

  $$new\ RRT_s=(1-\alpha)\times old\ RRT_s+\alpha\times RRT$$

- RTO

$$
RTO=RTT_s+4\times RTT_D
$$

$$
new\ RTT_D=(1-\beta)\times old\ RTT_D+\beta\times |RTT-RTT_s|
$$

- Karn 算法

  在计算RRT时，只要发生了重传，就不采用其往返时间样本

- 改进的Karn算法

  只要发生了重传，就把RTO**加倍**

####  5.6.2 选择确认 SACK

**Selective** ACK

由于一个块需要两个序号来定位，一个序号32位4个字节。于是最多只能在首部选项中表明4个字节块的信息，4*2\*4=32字节+1个字节指明是SACK选项+1个字符指明这个选项占用多少字节

- 选项最多40字节

### 5.7 TCP 的流量控制 

- 流量控制

  就是让发送方的发送速率不要太快，要让接受方来得及收，也不要让网络发生拥塞。

####  5.7.1 利用滑动窗口实现流量控制 

接收窗口 RWND （Receiver Window）

- 什么情况下可能发生死锁？
- 如何破解这个死锁？
  - 持续计时器，到时发送方就向接收方发送一个1字节的零窗口探测报文段。而对方就在确认这个报文段的时候给了现在的窗口值
  - 如果还是0，则再重置持续计时器
  - 如果不是0，死锁打破

####  5.7.2 TCP 的传输效率

三种机制来控制TCP报文段的发送时机：

1. TCP维持一个变量，最大报文段长度，MSS
2. 由发送方的应用进程明确要求发送，push
3. 维持一个时间计时器



- **发送方**糊涂窗口综合症，每来一个字节就发送一个报文段，很浪费

  解决方法，使用Nagle算法

  1. 发送方先只发第一字节
  2. 后续的缓冲在收到上一次发送的ACK后才发送
  3. 数据到达报文段最大长度/数据到达发送窗口的一半时 到达立即发送

- **接收方**糊涂窗口综合症，接收方每处理一个字节就ack一个1字节的接收窗口长度

  解决方法：

  使接收方等一段时间

  1. 接收方缓存足够容纳一个最长报文段
  2. 或者，接收缓存有有一半的空闲空间

  这两种情况之一，就发送确认报文，向发送方通知当前的窗口大小

### 5.8 TCP 的拥塞控制

某段时间，对网络中某资源的需求超过了其能提供的可用部分，则网路的性能就要变坏，这种现象称为拥塞

**congestion**

#### 5.8.1 拥塞控制的一般原理 

什么是拥塞控制？

- 拥塞控制就是防止过多的数据注入到网络中，防止网络中路由器或交换机过载
- 单纯的增加资源不一定能解决拥塞，相反还有可能更糟糕

什么是**开环控制**？

什么是**闭环控制**？

#### 5.8.2 TCP 的拥塞控制方法

- 基于**窗口**的方法来进行拥塞控制，该方法属于闭环控制方法

- 发送方维持一个拥塞窗口CWND(Congestion Window)

- 所以发送方真正的发送窗口值=min( RWND，CWND)

- 基本准则

  - 重传定时器**超时**

    可以认为发生了重传，则**已经**发生了拥塞

  - 收到3个相同（重复）的ACK

    **可能**将会发生拥塞，应尽快采取控制措施，**避免**发生拥塞 




- 慢开始
- 拥塞避免
- 快重传
- 快恢复

![拥塞控制](.\拥塞控制.png)

- 乘法减小
- 加法增大
- 快恢复后直接拥塞避免，加法增大

### 5.9 TCP 的运输连接管理

TCP的运输链接管理指的就是使得连接的建立和释放能够顺利的进行

#### 5.9.1 TCP 的连接建立-3次握手

A：client 主动打开

B：server  被动打开

A->B: SYN=1, seq=x                //报文段不携带数据，A消耗一个序列号

B->A: SYN=1, ACK=1, seq=y, ack=x+1 //报文段不携带数据，B消耗一个序列号

A->B: ACK=1, seq=x+1, ack=y+1  //如果这次报文段携带数据，A消耗一个序列号；如果不携带数据，则不消耗，下一次seq仍为x+1

#### 5.9.2 TCP 的连接释放-4次握手

A：client 主动关闭

B：server  被动关闭

A->B: FIN=1, seq=u   //报文段不携带数据，A消耗一个序列号

B->A: ACK=1, seq = v, ack=u+1  // 半关闭

B->A: FIN=1, ACK=1, seq=w, ack= u+1

A->B: ACK=1, seq=u+1, ack=w+1

A在发送最后的报文后2MSL时间才完全close



# 第 6 章应用层 

应用层就是规定这些**应用进程**在通信时所遵循的**协议**

### 6.1 域名系统 DNS 

**D**omain **N**ame **S**ystem

DNS数据报是UDP数据报

#### 6.1.1 域名系统概述 

任何一个因特网上的路由器和主机都有一个唯一的层次结构的名字，叫做域名

- 每个标号不超过63个字符
- 整个域名不超过255个字符

#### 6.1.2 互联网的域名结构

- TLD 顶级域名 Top Level Domain
  - 国家顶级域名 nTLD
  - 通用顶级域名 gTLD
  - 基础结构域名

#### 6.1.3 域名服务器

- 一个服务器所管辖的范围叫做区，**区<=域**

层级分类

- 根域名服务器
  - 所有的根域名服务器都知道所有的顶级域名服务器的域名和IP地址
- 顶级域名服务器
  - 负责在该顶级域名服务器注册的**所有二级域名**
- 权限域名服务器、
  - 负责一个**区**的域名服务器
- 本地域名服务器
  - 主机发出的DNS请求直接发送给本地域名服务器

域名解析过程

- 迭代解析
  - 本地域名服务器不断向根/顶级/区域域名服务器查询
- 递归解析
  - 本地域名服务器只向根域名服务器发送一次DNS请求

### 6.2 文件传送协议 

####  6.2.1 FTP 概述 

File Transfer Protocol

####  6.2.2 FTP 的基本工作原理

- 有交互


- 控制进程
  - 控制连接--TCP
  - 21端口
- 数据传输进程
  - 数据连接--TCP
  - 20端口

####  6.2.3 简单文件传送协议 TFTP

Trivial FTP

- 使用UDP数据报
- 只支持传输，无交互
- 工作模式很像停止等待协议

### 6.3 远程终端协议 TELNET 

- 使用TCP连接

### 6.4 万维网WWW 

#### 6.4.1 万维网概述 

万维网是一个大规模的、联机式的信息储藏所。

万维网是一个分布式的**超媒体**系统。

#### 6.4.2 统一资源定位符 URL 

- Uniform Resource Locator
- 表示从因特网上获得的资源的位置以及获得这些资源的方法
- \<协议\>://\<主机\>:\<端口\>/\<路径\>

#### 6.4.3 超文本传送协议 HTTP 

-  HyperText Transfer Protocol
-  规定了浏览器怎么样向万维网服务器请求万维网文档，以及服务器怎么把文档发送给浏览器
-  HTTP操作过程
  - 建立与服务器80端口的TCP连接
  - 发送HTTP请求报文
  - 收到HTTP相应报文
  - 释放TCP连接
-  代理服务器
  - 浏览器与代理服务器建立TCP连接，发送HTTP请求
  - 如果有这个缓存，则直接返回HTTP响应报文
  - 没有则代理服务器与因特网上的服务器建立TCP连接，发送HTTP请求
  - 代理服务器收到HTTP相应报文
  - 将内容先缓存起来，然后再返回给浏览器
-  Cookie
  - 万维网使用Cookie来追踪用户
  - 网站给用户有一个唯一的识别码

#### 6.4.4 万维网的文档 

##### 超文本标记语言 HTML HyperText Markup Language

```html
<HTML>
 <HEAD>
   <TITLE>一个HTML的例子</TITLE>
  </HEAD>
  <BODY>
    <H1>
      一级标题
    </H1>
    <p>
      一个段落
    </p>
  </BODY>
</HTML>  
```

- XML Extensible Markup Language
  - 设计宗旨是传输数据
- CSS Cascading Style Sheet
  - 用于格式化结构化的内容

##### 动态万维网文档

- 动态文档是在用户访问服务器时才由服务器动态创建的
- CGI 通用网关接口 **C**ommon **G**ateway  **I**nterface
  - 定义动态文档应该如何创建，输入数据如何提供给应用程序，输出结果如何使用

##### 活动万维网文档

- 活动文档（active document）技术通过把所有的工作都交给浏览器端来实现屏幕连续更新
- 每当浏览器请求一个活动文档时，服务器就返回一段程序副本在浏览器端运行
- JAVA是一种用于创建和运行活动文档的技术

#### 6.4.5 万维网的信息检索系统 

- 全文检索搜索引擎
  - google
  - baidu
- 分类目录搜索引擎
  - sina
  - 网易
  - 雅虎
  - 搜狐
  - 雅虎中国
- 垂直搜索引擎
  - 针对特定领域，特定人群的特定需求的搜索引擎
  - google scholar

#### 6.4.6 博客和微博 

#### 6.4.7 社交网络

### 6.5 电子邮件 

#### 6.5.1 电子邮件概述 

- 发送邮件的协议：SMTP （Simple Mail Transfer Protocol）

- 读取邮件的协议：POP3 （Post Office Protocol）和IMAP

- 邮件服务器必须能通吃充当client和serve，A给B发邮件时，邮件服务器A就是SMTP客户，B是服务器

- 邮件地址

  收件人邮箱名@邮箱所在主机的域名

  - 前者在域名范围内是唯一的
  - 后者再全世界是唯一的

#### 6.5.2 简单邮件传送协议 SMTP 

三个阶段

1. 连接建立：TCP连接建立在发送主机的SMTP客户和接受主机的SMTP服务器之间，**不适用**中间的邮件服务器
2. 邮件传送
3. 连接释放

#### 6.5.3 电子邮件的信息格式 

- 分为**信封**和**内容**
- `To:`
- `Subject:`
- `From`
- `Cc:`
- `Date:` 
- `Reply-To:`

#### 6.5.4 邮件读取协议 POP3 和 IMAP

- POP协议仅读取，就和邮局一样
  - 是客户服务器方式工作
- IMAP
  - 用户在PC上可以操纵ISP邮件服务器的邮件
  - 是客户服务器方式工作

#### 6.5.5 基于万维网的电子邮件

- 从A到A的邮件服务器使用HTTP协议
- 两个邮件服务器之间使用SMTP
- B的邮件服务器到B使用HTTP协议，**而不是POP3/IMAP**！ 

### 6.6 动态主机配置协议 DHCP

Dynamic Host Configuration Protocol

- 允许一台计算机加入新网络和获取IP地址而不用手工参与

  配置的项目有：

  - IP地址
  - 子网掩码
  - 默认路由器的IP地址
  - 域名服务器的IP地址

- 使用客户服务器方式

- 流程

  - 主机**广播**发送**发现报文**
  - 网路中至少有一台的DHCP中继代理（一个路由器）收到并把此发现报文**单播**给DHCP服务器
  - 中继代理收到**提供报文**，将此报文返回给主机

- 租用期

  - 因为分配的IP地址是临时的
  - 由DHCP服务器决定
  - 客户也可以在发现报文中提出对租用期的要求

### 6.7 P2P 应用

#### 6.7.1 具有集中目录服务器的 P2P 工作方式 

- 文件传输分散，但是文件定位集中
- Napster 下载免费MP3音乐

#### 6.7.2 具有全分布式结构的 P2P 文件共享程序 

- 无集中的查询服务器，使用洪泛法在用户间查询
- Gnutella
- 电骡 eMule
- BT BitTorrent

#### 6.7.3 在 P2P 对等方中搜索对象 

- 分布式散列表DHT （DIstributed Hash Table）
- Chord算法



## 英文名词

- TDM
  - 时分复用 (Time Division Multiplexing)

- FDM
  - 频分复用 (Frequency Division Multiplexing)
- CDMA
  - 码分多址  (Code Division Multiple Access)
- DSSS 
  - 直接序列扩频 (Direct Sequence Spread Spectrum)
- ADSL
  - Asymmetric Digital Subscriber Line
- DMT
  - Discrete Multi-Tone
- HFC
  - Hybrid Fiber Coax
- FTTx
  - Fiber To The x
- ISP
  - Internet Service Provider
- PPP
  - Ponit-to-Point Protocol
- CRC
  - Cyclic Redundancy Check
- FCS
  - Frame Check Sequence
- CSMA/CD
  - Carrier Sense Multiple Access with Collision Detection


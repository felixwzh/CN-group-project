# 复习 

## 第 3 章 数据链路层 

数据链路层的主要作用是如何**可靠**的把数据传输到相邻节点

###3.1 使用点对点信道的数据链路层

#### 3.1.1 数据链路 

- 把实现用来控制数据在link上传输的**通讯协议**的软件和硬件加在链路上，就构成了**数据链路**。

#### 3.1.2 三个基本问题

1.  封装成帧（framing）
   - 给IP数据报添加帧首部（e.g. **SOH**）和帧尾部（e.g. **EOT**），并且数据部分（即IP数据报）有最长限制MTU（Maximum Transfer Unit）
   - 首/尾部 的作用是**帧界定**，并且在数据传输出现差错的时候用处更加明显。可以直接丢弃这个帧，直到下一个有完整首部和尾部的帧。
2.  透明传输
   - 使用**字节填充**的方法
   - 如果IP数据报中刚好有EOT，则在EOT前面加一个转义字符ESC，在读取数据是删除这个ESC再给网络层即可。
   - 如果IP数据报中刚好有ESC，则在前面再加一个转义字符ESC，在读取时遇到连续的两个ESC就删除前一个即可。
3.  差错检测
   - 我们这里讨论的是**比特差错**，衡量标准是误码率BER（Bit Error Rate）
   - 使用CRC（Cyclic Redundant Check）循环冗余检验
   - 对于一个K位的组，选取一个R位的除数，在K位数据后加R-1个0，然后用K0000模2除以除数，得到R-1位的余数。这个余数就是FCS（Frame Check Sequence）。在发送这个组的数据时，把K位的数据后面拼接上这R-1位的余数，即使真正发送出去的数据
   - 在检验的时候，使用这个接受到的数据（K+R-1）位模2除以之前用的除数，如果结果为0，则接受，如果 结果非0，则认为出现了比特差错，丢弃这个组。
   - 使用CRC得到的仅仅是**无差错接受**，不是**可靠传输**。无法解决 帧丢失、重复、失序问题。

###3.2 点对点协议 PPP 

用户连接到ISP的链路使用PPP

#### 3.2.1 PPP 协议的特点

1. 简单
2. 封装成帧
3. 透明
4. 差错检验
5. 适应多种网络协议
6. 适应多种链路
7. 最大传输长度MTU
8. 检测链路连接状态
9. 网络层地址协商
10. 数据压缩协商

#### 3.2.2 PPP 协议的帧格式

- 字段的意义：
  - 首部：0x7E, 0xFF, 0x03 +2字节的协议+
  - 数据部分：(<1500字节的数据)
  - 尾部：2字节的FCS+0x7E
  - 两个帧之间只有一个0x7E
- 字节填充
  - 用于异步的字节传输
  - 使用0x7D作为转义字符
  - 0x7E->0x7D,0x5E
  - 0x7D->0x7D,0x5D
  - 小于0x20的ASCII控制字符，0x03->0x7D,0x23
- 零比特填充
  - 用于同步的比特连续传输
  - 在连续的5个1后面填充一个0

###3.3 使用广播信道的数据链路层

#### 3.3.1 局域网的数据链路层

- 局域网最主演的特点：
  1. 网络为一个单位所有
  2. 网络范围和站点数目均有限
- 局域网的拓扑有：
  - 星型网
  - 环状网
  - 总线网
  - 树状网

#### 3.3.2 CSMA/CD 协议

Carrie Sense Multiple Access with Collision Detection 载波监听多点接入/碰撞检测

**争用期**：512比特时间

**截短二进制指数避退算法** 

**强化碰撞**：32/48 比特时间

**帧间最小间隔**：96比特时间

1. 如果要发送数据，则一直监听直到有了96比特时间的空闲
2. 开始发送并且持续监听信道：
   1. 如果在512比特的争用期还没有发现碰撞，则这个帧可以顺利发送
   2. 若果有碰撞，则立即停止发送，并且发送一个人为干扰信号，执行指数退避 算法，等待r 倍的512比特时间。再开始1。如果16次还不成功则停止发送并且上报错。

#### 3.3.3 使用集线器的星形拓扑

- 双绞线以太网总是和集线器配合使用的。
- 使用集线器的以太网在逻辑上还是一个总线网，各站共享逻辑上的总线，使用的还是CSMA/CD协议
- 集线器就像一个多接口的转发器，他使用电子器件来模拟实际电缆线的工作。整个系统依然像一个传统的以太网那样运行。

#### 3.3.4 以太网的信道利用率

- $\tau$ 是以太网单程端到端**传播时延**，$2\tau$是争用期。
- $T_0$是发送帧用的时间
- $\alpha=\tau/T_0$ 参数来描述以太网的信道利用率，尽可能小比较好
  - 当数据率一定时，以太网的连线不能太长，否则$\tau$会太大
  - 以太网的帧不能太短，否则$T_0$太小导致$\alpha$太大

#### 3.3.5 以太网的 MAC 层

- MAC层的硬件地址，MAC地址，是局域网通信设备或端口的唯一标识符

  - 共48位
  - 前24位是组织唯一标识符
  - 后24位是扩展唯一标识符
  - I/G位：第一个字节的最低位，0->Individual 单个站地址，1-> Group 组地址（用来进行**多播**）
  - 当48位全为1时，是**广播**地址
  - 适配器检查MAC地址

- MAC帧的格式-共5个字段，最短64字节长

  1. 目的地址字段-6字节
  2. 源地址字段-6字节
  3. 类型字段-2字节，说明上层网络层的协议类型
  4. 数据字段-46~1500字节
  5. FCS字段-4字节
  6. 实际发送的还要多8个字节：，这部分字节不进行CRC校验
     - 7个字节的前同步码
     - 1个字节的帧开始界定符

  - 对收到 的MAC帧
    - 如果长度不是整数字节，丢弃
    - 如果FCS校验失败，丢弃
    - 如果数据字段的长度不在46~1500字节之间

### 3.4 扩展的以太网

#### 3.4.1 在物理层扩展以太网

- 使用集线器把多个星型以太网的集线器组成更大的以太网。把多个小碰撞域组成一个大的碰撞域
- 优点：
  - 原来不能通信的可以了，可以跨碰撞域
  - 扩大的以太网的物理范围
- 缺点：
  - 总的吞吐量没有提升
  - 如果不同碰撞域的数据率不一样，则不能连在一起

#### 3.4.2 在数据链路层扩展以太网

- 早期使用网桥，现在使用以太网交换机
- 网桥：根据MAC帧的目的地址对收到的帧进行转发和过滤
- 交换机：以太网交换机 / 第二层交换机，工作在数据链路层
- 有自学习算法，交换表一开始是空的
  - 先进行**自学习**，在交换表中查找源地址
    1. 如果没有，则将源地址、接口、有效时间添加到交换表中
    2. 如果有，则更新接口和有效时间
  - 再进行转发，在交换表中查找目的地址
    1. 如果没有，则向除了源接口的所有接口转发
    2. 如果有，则只向对应的接口转发
    3. 如果就是源接口，则丢弃这一帧
- 转发器、集线器、网桥、交换机的不同点
  - 工作的层不一样
  - 前两个简单的进行比特转发，后两个需要读帧的含义
  - 网桥一般2~4个接口，而交换机有十几或几十个接口
  - 网桥的接入一般是网段，而交换机还可以是单独的主机

#### 3.4.3 虚拟局域网 VLAN （Virtual Local Area Network）

- 在以太网帧中原本的6+6+2+（46~1500）+4字节中添加4个字节的**VLAN标记字段**在源地址字段之后。变成了**802.1Q帧**
- 前两个字节为**IEEE 802.1Q标记类型**
- 后两个字节前3位为用户优先级，第4位为规范格式指示符，后12位为**VID**，VLAN-ID
- 以太网的最长帧长度从1518->1522字节

